<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trắc nghiệm từ vựng Tiếng Anh</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
      body {
        font-family: 'Inter', sans-serif;
      }
    </style>

    <!-- Enhanced Storage Manager for Mobile -->
    <script>
      // Global storage manager
      window.StorageManager = {
        storage: null,
        fallbackStorage: {},
        
        init() {
          // Test localStorage first
          if (this.testStorage('localStorage')) {
            this.storage = localStorage;
            console.log('Using localStorage');
            return;
          }
          
          // Test sessionStorage
          if (this.testStorage('sessionStorage')) {
            this.storage = sessionStorage;
            console.log('Using sessionStorage');
            return;
          }
          
          // Use memory fallback
          this.storage = this.createMemoryStorage();
          console.log('Using memory storage');
        },
        
        testStorage(type) {
          try {
            const test = '__storage_test__';
            const storage = window[type];
            storage.setItem(test, test);
            storage.removeItem(test);
            return true;
          } catch (e) {
            console.warn(`${type} not available:`, e);
            return false;
          }
        },
        
        createMemoryStorage() {
          return {
            getItem: (key) => this.fallbackStorage[key] || null,
            setItem: (key, value) => {
              this.fallbackStorage[key] = value;
              // Try to persist to sessionStorage if available
              try {
                if (window.sessionStorage) {
                  sessionStorage.setItem(key, value);
                }
              } catch (e) {
                console.warn('Could not backup to sessionStorage');
              }
            },
            removeItem: (key) => {
              delete this.fallbackStorage[key];
              try {
                if (window.sessionStorage) {
                  sessionStorage.removeItem(key);
                }
              } catch (e) {
                console.warn('Could not remove from sessionStorage');
              }
            },
            clear: () => {
              this.fallbackStorage = {};
              try {
                if (window.sessionStorage) {
                  sessionStorage.clear();
                }
              } catch (e) {
                console.warn('Could not clear sessionStorage');
              }
            },
            key: (index) => Object.keys(this.fallbackStorage)[index] || null,
            get length() {
              return Object.keys(this.fallbackStorage).length;
            }
          };
        },
        
        // Load any existing data from sessionStorage
        loadFromSessionStorage() {
          try {
            if (window.sessionStorage) {
              Object.keys(sessionStorage).forEach(key => {
                this.fallbackStorage[key] = sessionStorage.getItem(key);
              });
            }
          } catch (e) {
            console.warn('Could not load from sessionStorage');
          }
        }
      };
      
      // Initialize storage manager
      StorageManager.init();
      StorageManager.loadFromSessionStorage();
      
      // Override localStorage globally
      window.localStorage = StorageManager.storage;
      
      // Mobile detection and optimizations
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        // Show storage status notification
        setTimeout(() => {
          const notification = document.createElement('div');
          notification.style.cssText = `
            position: fixed;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 10000;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
          `;
          
          if (StorageManager.storage === StorageManager.fallbackStorage) {
            notification.textContent = '📱 Sử dụng bộ nhớ tạm thời';
            notification.style.background = 'rgba(239, 68, 68, 0.9)';
          } else {
            notification.textContent = '✅ Bộ nhớ hoạt động bình thường';
          }
          
          document.body.appendChild(notification);
          
          setTimeout(() => {
            if (notification.parentNode) {
              notification.parentNode.removeChild(notification);
            }
          }, 3000);
        }, 1000);
        
        // Mobile UX improvements
        const meta = document.querySelector('meta[name="viewport"]');
        if (meta) {
          meta.setAttribute('content', 'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
        }
        
        const style = document.createElement('style');
        style.textContent = `
          @media (max-width: 768px) {
            input, textarea, select {
              font-size: 16px !important;
            }
            
            button {
              min-height: 44px;
            }
            
            .touch-target {
              min-height: 44px;
              min-width: 44px;
            }
          }
        `;
        document.head.appendChild(style);
      }
      
      // Debug info
      console.log('Storage Manager initialized:', {
        storageType: StorageManager.storage === localStorage ? 'localStorage' : 
                     StorageManager.storage === sessionStorage ? 'sessionStorage' : 'memory',
        isMobile: isMobile,
        availableData: Object.keys(StorageManager.fallbackStorage)
      });
      
      // Test storage functionality
      setTimeout(() => {
        try {
          // Test saving data
          localStorage.setItem('test_key', 'test_value');
          const retrieved = localStorage.getItem('test_key');
          console.log('Storage test:', { saved: 'test_value', retrieved });
          
          // Check for existing customTopics
          const customTopics = localStorage.getItem('customTopics');
          console.log('Existing customTopics:', customTopics);
          
          if (customTopics) {
            try {
              const parsed = JSON.parse(customTopics);
              console.log('Parsed customTopics:', parsed);
              console.log('Number of saved topics:', Object.keys(parsed).length);
            } catch (e) {
              console.error('Error parsing customTopics:', e);
            }
          }
          
          // Clean up test
          localStorage.removeItem('test_key');
        } catch (e) {
          console.error('Storage test failed:', e);
        }
      }, 2000);
      
      // Create debug panel for mobile
      if (isMobile) {
        setTimeout(() => {
          const debugPanel = document.createElement('div');
          debugPanel.id = 'debug-panel';
          debugPanel.style.cssText = `
            position: fixed;
            bottom: 10px;
            right: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 8px;
            font-size: 12px;
            font-family: monospace;
            z-index: 10001;
            max-width: 200px;
            max-height: 150px;
            overflow: auto;
          `;
          
          const customTopics = localStorage.getItem('customTopics');
          let debugInfo = `Storage: OK\n`;
          debugInfo += `customTopics: ${customTopics ? 'Found' : 'Not found'}\n`;
          
          if (customTopics) {
            try {
              const parsed = JSON.parse(customTopics);
              debugInfo += `Topics: ${Object.keys(parsed).length}\n`;
              debugInfo += `Keys: ${Object.keys(parsed).join(', ')}`;
            } catch (e) {
              debugInfo += `Parse error: ${e.message}`;
            }
          }
          
          // Add sync status
          if (window.SyncManager) {
            debugInfo += `\nSync: ${window.SyncManager.isOnline ? '🟢 Online' : '🔴 Offline'}`;
            if (window.SyncManager.userId) {
              debugInfo += `\nUser: ${window.SyncManager.userId.slice(0, 8)}...`;
            }
          }
          
          debugPanel.textContent = debugInfo;
          document.body.appendChild(debugPanel);
          
          // Remove after 10 seconds
          setTimeout(() => {
            if (debugPanel.parentNode) {
              debugPanel.parentNode.removeChild(debugPanel);
            }
          }, 10000);
        }, 3000);
      }
      
      // Add test data function
      window.createTestData = function() {
        const testData = {
          "Test Topic 1": [
            {
              englishWord: "hello",
              englishDescription: "A greeting",
              vietnameseMeaning: "xin chào",
              partOfSpeech: "interjection",
              examples: ["Hello, how are you?"]
            },
            {
              englishWord: "world",
              englishDescription: "The earth",
              vietnameseMeaning: "thế giới",
              partOfSpeech: "noun",
              examples: ["Hello world!"]
            }
          ],
          "Test Topic 2": [
            {
              englishWord: "test",
              englishDescription: "A trial",
              vietnameseMeaning: "kiểm tra",
              partOfSpeech: "noun",
              examples: ["This is a test"]
            }
          ]
        };
        
        localStorage.setItem('customTopics', JSON.stringify(testData));
        console.log('Test data created:', testData);
        
        // Show success message
        const msg = document.createElement('div');
        msg.style.cssText = `
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translateX(-50%) translateY(-50%);
          background: rgba(34, 197, 94, 0.9);
          color: white;
          padding: 20px;
          border-radius: 10px;
          font-size: 16px;
          z-index: 10002;
          text-align: center;
        `;
        msg.textContent = '✅ Đã tạo dữ liệu test!\nRefresh trang để xem';
        document.body.appendChild(msg);
        
        setTimeout(() => {
          if (msg.parentNode) {
            msg.parentNode.removeChild(msg);
          }
        }, 3000);
      };
      
      // Add test button for mobile
      if (isMobile) {
        setTimeout(() => {
          const testBtn = document.createElement('button');
          testBtn.textContent = '🧪 Test Data';
          testBtn.style.cssText = `
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(59, 130, 246, 0.9);
            color: white;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            z-index: 10001;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
          `;
          testBtn.onclick = window.createTestData;
          document.body.appendChild(testBtn);
          
          // Remove after 30 seconds
          setTimeout(() => {
            if (testBtn.parentNode) {
              testBtn.parentNode.removeChild(testBtn);
            }
          }, 30000);
        }, 4000);
      }
    </script>

  <script type="importmap">
{
  "imports": {
    "react": "https://esm.sh/react@^19.1.0",
    "react-dom/": "https://esm.sh/react-dom@^19.1.0/",
    "react/": "https://esm.sh/react@^19.1.0/",
    "@google/genai": "https://esm.sh/@google/genai@^1.9.0",
    "vite": "https://esm.sh/vite@^7.0.5",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^4.6.0",
    "firebase/app": "https://esm.sh/firebase@^10.7.0/app",
    "firebase/firestore": "https://esm.sh/firebase@^10.7.0/firestore",
    "firebase/auth": "https://esm.sh/firebase@^10.7.0/auth"
  }
}
</script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'firebase/app';
    import { getFirestore, doc, setDoc, getDoc, onSnapshot } from 'firebase/firestore';
    import { getAuth, signInAnonymously, onAuthStateChanged } from 'firebase/auth';

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDp28WsKI6-mA-8TwFYlBLAbYwIcoMO984",
      authDomain: "vocab-quiz-app-c161c.firebaseapp.com",
      projectId: "vocab-quiz-app-c161c",
      storageBucket: "vocab-quiz-app-c161c.firebasestorage.app",
      messagingSenderId: "715035572289",
      appId: "1:715035572289:web:a0e8bc84f57e4c84dbeec0"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Global sync manager
    window.SyncManager = {
      userId: null,
      isOnline: false,
      
      async init() {
        try {
          // Sign in anonymously
          const userCredential = await signInAnonymously(auth);
          this.userId = userCredential.user.uid;
          console.log('Signed in as:', this.userId);
          
          // Listen for auth state changes
          onAuthStateChanged(auth, (user) => {
            if (user) {
              this.userId = user.uid;
              this.isOnline = true;
              this.loadFromCloud();
              this.setupRealtimeSync();
              console.log('User authenticated:', user.uid);
            } else {
              this.isOnline = false;
              console.log('User signed out');
            }
          });
          
        } catch (error) {
          console.error('Firebase init error:', error);
          this.isOnline = false;
        }
      },
      
      async saveToCloud(data) {
        if (!this.userId || !this.isOnline) return;
        
        try {
          const userDoc = doc(db, 'users', this.userId);
          await setDoc(userDoc, {
            customTopics: data,
            lastUpdated: new Date().toISOString()
          });
          console.log('Data saved to cloud');
        } catch (error) {
          console.error('Save to cloud error:', error);
        }
      },
      
      async loadFromCloud() {
        if (!this.userId || !this.isOnline) return;
        
        try {
          const userDoc = doc(db, 'users', this.userId);
          const docSnap = await getDoc(userDoc);
          
          if (docSnap.exists()) {
            const data = docSnap.data();
            if (data.customTopics) {
              localStorage.setItem('customTopics', JSON.stringify(data.customTopics));
              console.log('Data loaded from cloud');
              return data.customTopics;
            }
          }
        } catch (error) {
          console.error('Load from cloud error:', error);
        }
        return null;
      },
      
      setupRealtimeSync() {
        if (!this.userId || !this.isOnline) return;
        
        const userDoc = doc(db, 'users', this.userId);
        onSnapshot(userDoc, (doc) => {
          if (doc.exists()) {
            const data = doc.data();
            if (data.customTopics) {
              localStorage.setItem('customTopics', JSON.stringify(data.customTopics));
              console.log('Data synced in real-time');
            }
          }
        });
      },
      
      // Override localStorage to sync with cloud
      setupLocalStorageSync() {
        const originalSetItem = localStorage.setItem;
        localStorage.setItem = (key, value) => {
          originalSetItem.call(localStorage, key, value);
          
          if (key === 'customTopics') {
            try {
              const data = JSON.parse(value);
              this.saveToCloud(data);
            } catch (e) {
              console.error('Error syncing to cloud:', e);
            }
          }
        };
      }
    };

    // Initialize sync manager
    SyncManager.init().then(() => {
      SyncManager.setupLocalStorageSync();
    });
  </script>
  <script type="module" crossorigin src="/vocab-quiz-app/assets/index-CiZBBJAF.js"></script>
  <link rel="stylesheet" crossorigin href="/vocab-quiz-app/assets/index-CwP58aj2.css">
</head>
  <body class="bg-slate-50 text-slate-900">
    <div id="root"></div>

  </body>
</html>